<!DOCTYPE html>
<html>
<head>
<title>Hello, Canvas World!</title>
<!--[if IE]><script src="excanvas.js"></script><![endif]-->
<script type="text/javascript">
/*  
            50 y 
            ^  -50 
            | / z
            |/       x
-50 -----------------> +50
          / |
     +50 /  |
          -50

        [7]------[4]
       / |      / |
     [3]------[0] |
      |  |     |  |
      | [6]----|-[5]
      |/       |/
     [2]------[1]

*/

/*
var g_points = [
    {x: 5, y: 5, z: 5}, // g_points[0]
    {x: 5, y:-5, z: 5}, // g_points[1]
    {x:-5, y:-5, z: 5}, // g_points[2]
    {x:-5, y: 5, z: 5}, // g_points[3]
    {x: 5, y: 5, z:-5}, // g_points[4]
    {x: 5, y:-5, z:-5}, // g_points[5]
    {x:-5, y:-5, z:-5}, // g_points[6]
    {x:-5, y: 5, z:-5}  // g_points[7]
  ];
*/
var g_mario = [];    // new Array( 16 * 16 );
/*
// ƒƒ}ƒŠƒI„
// ddddddddddddd   
// dddddd¬¬¬¬¬dd   
// ddddd¬¬¬¬¬¬¬¬¬  
// ddddd¡¡¡  ¡ d¡¡¡
// dddd¡ ¡   ¡  ¡¡¡
// dddd¡ ¡¡   ¡   ¡
// dddd¡¡    ¡¡¡¡¡d
// dddddd       ¡dd
// dd¡¡¡¡¡¬¡¡¡¬¡ddd
// d¡¡¡¡¡¡¡¬¡¡¡¬dd¡
//   ¡¡¡¡¡¡¬¬¬¬¬dd¡
//    d¬¬¡¬¬ ¬¬ ¬¡¡
// d d¡¬¬¬¬¬¬¬¬¬¬¡¡
// dd¡¡¡¬¬¬¬¬¬¬¬¬¡¡
// d¡¡¡¬¬¬¬¬¬¬ddddd
// d¡dd¬¬¬¬dddddddd

// ƒF‚Ìí—Ş„
// "–³":"#000000"
// "”’":"#ffffff"
// "”§":"#ffcccc"
// "’ƒ":"#800000"
// "Ô":"#ff0000"
// "‰©":"#ffff00"
// "—Î":"#00ff00"
// "…":"#00ffff"
// "Â":"#0000ff"
// "‡":"#800080"
*/
var g_strLines = [
        "–³–³–³–³–³–³–³–³–³–³–³–³–³”§”§”§", 
        "–³–³–³–³–³–³ÔÔÔÔÔ–³–³”§”§”§", 
        "–³–³–³–³–³ÔÔÔÔÔÔÔÔÔ”§”§", 
        "–³–³–³–³–³’ƒ’ƒ’ƒ”§”§’ƒ”§–³ÔÔÔ", 
        "–³–³–³–³’ƒ”§’ƒ”§”§”§’ƒ”§”§ÔÔÔ", 
        "–³–³–³–³’ƒ”§’ƒ’ƒ”§”§”§’ƒ”§”§”§Ô", 
        "–³–³–³–³’ƒ’ƒ”§”§”§”§’ƒ’ƒ’ƒ’ƒÔ–³", 
        "–³–³–³–³–³–³”§”§”§”§”§”§”§Ô–³–³", 
        "–³–³ÔÔÔÔÔÂÔÔÔÂÔ–³–³–³", 
        "–³ÔÔÔÔÔÔÔÂÔÔÔÂ–³–³’ƒ", 
        "”§”§ÔÔÔÔÔÔÂÂÂÂÂ–³–³’ƒ", 
        "”§”§”§–³ÂÂÔÂÂ‰©ÂÂ‰©Â’ƒ’ƒ", 
        "–³”§–³’ƒÂÂÂÂÂÂÂÂÂÂ’ƒ’ƒ", 
        "–³–³’ƒ’ƒ’ƒÂÂÂÂÂÂÂÂÂ’ƒ’ƒ", 
        "–³’ƒ’ƒ’ƒÂÂÂÂÂÂÂ–³–³–³–³–³", 
        "–³’ƒ–³–³ÂÂÂÂ–³–³–³–³–³–³–³–³"
    ];

var canvas;
var ctx;
var X_MAX = 640;
var Y_MAX = 480;
var BASE_X = 250;
var BASE_Y = 150;
var RAD_STEP = Math.PI / 180;
var g_vp = 500;
var g_rad_x = 0;
var g_rad_y = 0;
var g_rad_z = 0;

function init()
{
    g_rad_x = RAD_STEP * 0;
    g_rad_y = RAD_STEP * 1;
    g_rad_z = RAD_STEP * -5;

    txtX_rad.value = g_rad_x;
    txtY_rad.value = g_rad_y;
    txtZ_rad.value = g_rad_z;

    canvas = document.getElementById("canvas");
    ctx = canvas.getContext("2d");
    clearScreen();
    
    initMario();

    setInterval(draw, 60);
}

function initMario(){

    var strLine;
    var strMessage;
    for ( y = 0; y < g_strLines.length; y++ )
    {
        strMessage = "";
        strLine = g_strLines[y];
        for ( x = 0; x < strLine.length; x++ )
        {
            var points = [
                {x: 5, y: 5, z: 5}, // g_points[0]
                {x: 5, y:-5, z: 5}, // g_points[1]
                {x:-5, y:-5, z: 5}, // g_points[2]
                {x:-5, y: 5, z: 5}, // g_points[3]
                {x: 5, y: 5, z:-5}, // g_points[4]
                {x: 5, y:-5, z:-5}, // g_points[5]
                {x:-5, y:-5, z:-5}, // g_points[6]
                {x:-5, y: 5, z:-5}  // g_points[7]
              ];
            var c = strLine.substr( x, 1 );
            adjustPoint( points, x, y );
            var style = getRgbColor( c );
            if ( c != "–³" )
            {
                g_mario.push( { cube:points, style:style } );
            }
        }
    }
}

function getRgbColor( c )
{
    var colorHash = {
        "–³":"#000000",
        "”’":"#ffffff",
        "”§":"#ffcccc",
        "’ƒ":"#800000",
        "Ô":"#ff0000",
        "‰©":"#ffff00",
        "—Î":"#00ff00",
        "…":"#00ffff",
        "Â":"#0000ff",
        "‡":"#800080"
    }
    return colorHash[ c ];
}

function adjustPoint( points, x, y )
{
    var i = 0;
    for ( i = 0; i < points.length; i++ )
    {
        points[i].x += x * 15;
        points[i].y += y * 15;
    }
}

function draw() {
    clearScreen();

    var i;
    for ( i = 0; i < g_mario.length; i++ )
    {
        drawMario( g_mario[i] );
    }
}

function drawMario( mario ){
    var p;
    var p2 = [];
    var i, s;
    var x1, y1, z1;
    var x2, y2, z2;
    var x3, y3, z3;
    var points = mario.cube;
    var style = mario.style;
    
    for(i = 0; i < points.length; i++ ) {
        p = points[i];

        // ˆÈ‰ºà–¾‚ÍuCŒ¾Œê‚É‚æ‚é‚Í‚¶‚ß‚Ä‚ÌƒAƒ‹ƒSƒŠƒYƒ€“ü–åv‚Ì‰ğà‚ğQl‚É‹LÚ
        //
        // ¡ Amazon.co.jpF CŒ¾Œê‚É‚æ‚é‚Í‚¶‚ß‚Ä‚ÌƒAƒ‹ƒSƒŠƒYƒ€“ü–å: ‰Í¼ ’©—Y: –{
        // http://www.amazon.co.jp/dp/4874085008
        // 
        // 8.4 ‚RŸŒ³À•W•ÏŠ·
        // 
        
        // y²ü‚è‚ÉƒÀŠp‰ñ“]‚·‚é
        // x1 = x * cos(ƒÀ) + z * sin(ƒÀ)
        // y1 = y
        // z1 = -x * sin(ƒÀ) + z * cos(ƒÀ)
        x1 = p.x * Math.cos(g_rad_y) + p.z * Math.sin(g_rad_y);
        y1 = p.y;
        z1 = -p.x * Math.sin(g_rad_y) + p.z * Math.cos(g_rad_y);
        
        // x²ü‚è‚Éƒ¿Šp‰ñ“]‚·‚é
        // x2 = x1
        // y2 = y1 * cos(ƒ¿) - z1 * sin(ƒ¿)
        // z2 = y1 * sin(ƒ¿) + z1 * cos(ƒ¿)
        x2 = x1;
        y2 = y1 * Math.cos(g_rad_x) - z1 * Math.sin(g_rad_x);
        z2 = y1 * Math.sin(g_rad_x) + z1 * Math.cos(g_rad_x);
        
        // z²ü‚è‚ÉƒÁŠp‰ñ“]‚·‚é
        // x2 = x2 * cos(ƒÁ) - y2 * sin(ƒÁ)
        // y2 = x2 * sin(ƒÁ) + y2 * cos(ƒÁ)
        // z2 = z2
        x3 = x2 * Math.cos(g_rad_z) - y2 * Math.sin(g_rad_z);
        y3 = x2 * Math.sin(g_rad_z) + y2 * Math.cos(g_rad_z);
        z3 = z2;
        
        // ŒvZŒ‹‰Ê‚ğ–ß‚·
        p.x = x3;
        p.y = y3;
        p.z = z3;
        
        // ã‹L‚Ì‰ñ“]‚Å“¾‚ç‚ê‚½À•W‚ğ z = 0 •½–Ê‚É•½s“Š‰e‚·‚é
        // ix3, y3, z3 ‚Ì‚¤‚¿Az3 ‚ğ–³‹‚·‚é‚±‚Æ‚ª z = 0 ‚Ö‚Ì•½s“Š‰e‚ğˆÓ–¡‚·‚éBj
        s = g_vp / (g_vp - p.z);
        p2[i] = { x: p.x * s, y: p.y * s };
    }
    drawCube(p2, style);
}

function drawCube(p, style){
    ctx.beginPath();
    ctx.strokeStyle = style;
/*
            50 y 
            ^  -50 
            | / z
            |/       x
-50 -----------------> +50
          / |
     +50 /  |
          -50

        [7]------[4]
       / |      / |
     [3]------[0] |
      |  |     |  |
      | [6]----|-[5]
      |/       |/
     [2]------[1]

*/
    ctx.moveTo(p[0].x + BASE_X, p[0].y + BASE_Y);
    ctx.lineTo(p[1].x + BASE_X, p[1].y + BASE_Y);
    ctx.lineTo(p[2].x + BASE_X, p[2].y + BASE_Y);
    ctx.lineTo(p[3].x + BASE_X, p[3].y + BASE_Y);
    ctx.lineTo(p[0].x + BASE_X, p[0].y + BASE_Y);
    ctx.lineTo(p[4].x + BASE_X, p[4].y + BASE_Y);
    ctx.lineTo(p[5].x + BASE_X, p[5].y + BASE_Y);
    ctx.lineTo(p[6].x + BASE_X, p[6].y + BASE_Y);
    ctx.lineTo(p[7].x + BASE_X, p[7].y + BASE_Y);
    ctx.lineTo(p[4].x + BASE_X, p[4].y + BASE_Y);
    ctx.moveTo(p[1].x + BASE_X, p[1].y + BASE_Y);
    ctx.lineTo(p[5].x + BASE_X, p[5].y + BASE_Y);
    ctx.moveTo(p[2].x + BASE_X, p[2].y + BASE_Y);
    ctx.lineTo(p[6].x + BASE_X, p[6].y + BASE_Y);
    ctx.moveTo(p[3].x + BASE_X, p[3].y + BASE_Y);
    ctx.lineTo(p[7].x + BASE_X, p[7].y + BASE_Y);
    ctx.closePath();
    ctx.stroke();
}

function clearScreen() {
    ctx.fillStyle = "rgb( 0, 0, 0 )";
    ctx.fillRect( 0, 0, X_MAX, Y_MAX );
}

function btnX_minus_onclick() {
    g_rad_x -= RAD_STEP;
    txtX_rad.value = g_rad_x;
}

function btnX_plus_onclick() {
    g_rad_x += RAD_STEP;
    txtX_rad.value = g_rad_x;
}

function btnY_minus_onclick() {
    g_rad_y -= RAD_STEP;
    txtY_rad.value = g_rad_y;
}

function btnY_plus_onclick() {
    g_rad_y += RAD_STEP;
    txtY_rad.value = g_rad_y;
}

function btnZ_minus_onclick() {
    g_rad_z -= RAD_STEP;
    txtZ_rad.value = g_rad_z;
}

function btnZ_plus_onclick() {
    g_rad_z += RAD_STEP;
    txtZ_rad.value = g_rad_z;
}

</script>
</head>
<body onload="init()">
<canvas id="canvas" width="640" height="480"></canvas>
<a href="https://github.com/cx20/hello/blob/master/html5/canvas/4-4.mario.html" target="_blank">View Source</a>
<br />
x²‚Ì‰ñ“]Šp:
<input id="btnX_minus" type="button" value="-" onclick="return btnX_minus_onclick()" />
<input id="txtX_rad" type="text" style="text-align: right" />
<input id="btnX_plus" type="button" value="+" onclick="return btnX_plus_onclick()" /><br />
y²‚Ì‰ñ“]Šp:
<input id="btnY_minus" type="button" value="-" onclick="return btnY_minus_onclick()" />
<input id="txtY_rad" type="text" style="text-align: right" />
<input id="btnY_plus" type="button" value="+" onclick="return btnY_plus_onclick()" /><br />
z²‚Ì‰ñ“]Šp:
<input id="btnZ_minus" type="button" value="-" onclick="return btnZ_minus_onclick()" />
<input id="txtZ_rad" type="text" style="text-align: right" />
<input id="btnZ_plus" type="button" value="+" onclick="return btnZ_plus_onclick()" /><br />
</body>
</html>
